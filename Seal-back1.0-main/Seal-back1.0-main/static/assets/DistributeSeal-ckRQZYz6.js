import{_ as v,U as w,c,a as t,b as f,d as k,e as h,v as y,f as b,w as q,r as I,t as m,n as T,g as S,h as F,i as x,F as V,j as A,T as M,k as g,u as D,o as p}from"./index-BvItkERQ.js";const _={name:"DistributeSeal",components:{QrcodeStream:w},setup(){return{notificationStore:D()}},data(){return{scannedSeal:null,scannerMessage:"กำลังเปิดกล้อง...",distributionType:"single",quantity:"",technicianCode:"",note:"",worker:null,isProcessing:!1,manualCode:"",showAddCodeInput:!1,additionalCode:"",distributionCodes:[]}},computed:{isFormValid(){return this.scannedSeal&&this.technicianCode&&(this.distributionType==="single"||this.distributionType==="quantity"&&this.quantity>0)}},methods:{async onInit(n){try{await n,this.scannerMessage="วางบาร์โค้ดให้อยู่ในกรอบ"}catch(e){console.error(e),this.scannerMessage="ไม่สามารถเปิดกล้องได้"}},async onDecode(n){if(n)try{const e=n.trim().toUpperCase();if(e.match(/^F\d+$/)){const a=await this.checkSealStatus(e);new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10...").play(),this.scannedSeal={code:e,type:"F-type",status:"พร้อมใช้งาน"}}else throw new Error("รหัส Seal ไม่ถูกต้อง (ต้องขึ้นต้นด้วย F ตามด้วยตัวเลข)")}catch(e){alert(e.message),this.resetForm()}},async handleManualInput(){var n;if(this.manualCode)try{const e=this.manualCode.trim().toUpperCase(),a=await g.get(`/api/seals/${e}`);if(a.data&&!a.data.error)this.scannedSeal={code:e,type:a.data.type||"ไม่ระบุ",status:a.data.status||"พร้อมใช้งาน"};else throw new Error(((n=a.data)==null?void 0:n.message)||"ไม่พบข้อมูล Seal")}catch(e){console.error("Manual input error:",e),alert(e.message||"เกิดข้อผิดพลาดในการตรวจสอบรหัส")}},async distributeSeal(){var n,e,a,l,s;try{if(!this.technicianCode){alert("กรุณากรอกรหัสช่าง");return}if(this.distributionCodes.length===0)if(this.distributionType==="single"&&this.scannedSeal)this.distributionCodes=[this.scannedSeal.code];else{alert("กรุณาระบุรหัส Seal ที่ต้องการจ่าย");return}const o=await g.post("/api/seals/assign-by-techcode",{technician_code:this.technicianCode,seal_numbers:this.distributionCodes,note:this.note||""}),d=JSON.parse(localStorage.getItem("sealHistory")||"[]");this.distributionCodes.forEach(i=>{const u={type:"distribute",icon:"fas fa-share-alt",title:"จ่าย Seal",details:`รหัส: ${i} ให้กับรหัสช่าง: ${this.technicianCode}`,time:new Date().toLocaleString("th-TH")};d.unshift(u)}),localStorage.setItem("sealHistory",JSON.stringify(d)),alert("✅ ทำรายการสำเร็จ"),this.resetForm()}catch(o){if(console.error("Distribution error:",o),(a=(e=(n=o.response)==null?void 0:n.data)==null?void 0:e.message)!=null&&a.includes("successfully"))alert("✅ ทำรายการสำเร็จ"),this.resetForm();else{const d=((s=(l=o.response)==null?void 0:l.data)==null?void 0:s.message)||o.message||"เกิดข้อผิดพลาดในการจ่าย Seal";alert(`❌ ${d}`)}}},resetForm(){this.scannedSeal=null,this.technicianCode="",this.note="",this.scannerMessage="กำลังเปิดกล้อง...",this.distributionType="single",this.quantity="",this.distributionCodes=[],this.showAddCodeInput=!1,this.additionalCode=""},generateSealRange(n,e){const a=n.match(/^(F\d*)(\d+)$/);if(!a)return null;const l=a[1],s=parseInt(a[2]),o=a[2].length,d=[];for(let i=0;i<e;i++){const u=(s+i).toString().padStart(o,"0");d.push(`${l}${u}`)}return d},async checkSealStatus(n){var e,a,l,s,o,d,i,u;try{console.log("Checking seal status for:",n);const r=await g.post(`/api/seals/${n}`,{headers:{"Content-Type":"application/json"}});if(console.log("Seal status response:",r.data),r.data&&(r.data.status==="available"||r.data.status==="พร้อมใช้งาน"))return{status:"available",code:n};throw new Error(`Seal ${n} ไม่สามารถจ่ายได้ (สถานะ: ${((e=r.data)==null?void 0:e.status)||"ไม่ทราบ"})`)}catch(r){throw console.error("Error checking seal:",{message:r.message,response:(a=r.response)==null?void 0:a.data,status:(l=r.response)==null?void 0:l.status,headers:(s=r.response)==null?void 0:s.headers}),((o=r.response)==null?void 0:o.status)===401?new Error("Token หมดอายุ กรุณาเข้าสู่ระบบใหม่"):((d=r.response)==null?void 0:d.status)===404?new Error(`ไม่พบ Seal ${n} ในระบบ`):new Error(((u=(i=r.response)==null?void 0:i.data)==null?void 0:u.message)||"ไม่สามารถตรวจสอบสถานะ Seal ได้")}},async onFileSelected(n){const e=n.target.files[0];if(e)try{this.isProcessing=!0,this.scannerMessage="กำลังอ่านข้อความจากรูปภาพ...";const{data:{text:a}}=await this.worker.recognize(e);console.log("Recognized text:",a);const l=a.match(/F\d+/g);if(l)this.onDecode(l[0]);else throw new Error("ไม่พบรหัส Seal ในรูปภาพ")}catch(a){console.error("Error processing image:",a),alert(a.message||"ไม่สามารถอ่านรหัส Seal จากรูปภาพได้")}finally{this.isProcessing=!1,this.scannerMessage="วางบาร์โค้ดให้อยู่ในกรอบ"}},async generateDistributionCodes(){var n;if(!(!((n=this.scannedSeal)!=null&&n.code)||!this.quantity))try{const e=this.scannedSeal.code,a=e.match(/^([A-Z]*)(\d+)$/);if(!a){this.distributionCodes=[e];return}const l=a[1],s=a[2],o=s.length,d=parseInt(s),i=Array.from({length:this.quantity},(u,r)=>{const C=(d+r).toString().padStart(o,"0");return l+C});try{const r=(await g.post("/api/seals/check",{seal_numbers:i})).data.unavailable||[];r.length>0?(alert(`❌ ไม่สามารถจ่าย Seal ได้ เนื่องจากไม่พบรหัสต่อไปนี้:
${r.join(`
`)}`),this.distributionCodes=i.filter(C=>!r.includes(C))):this.distributionCodes=i}catch(u){console.error("Check seals error:",u),alert("❌ เกิดข้อผิดพลาดในการตรวจสอบ Seal"),this.distributionCodes=[]}}catch(e){console.error("Generate error:",e),alert("❌ ไม่สามารถสร้างรหัสซีลต่อเนื่องได้"),this.distributionCodes=[]}},isValidCode(n){return n&&n.length>0&&!this.distributionCodes.includes(n)},addAdditionalCode(){this.isValidCode(this.additionalCode)&&(this.distributionCodes.push(this.additionalCode),this.additionalCode="",this.showAddCodeInput=!1)},removeCode(n){this.distributionCodes=this.distributionCodes.filter(e=>e!==n),this.quantity=this.distributionCodes.length},addHistory(n){const e=JSON.parse(localStorage.getItem("sealHistory")||"[]");e.unshift(n),localStorage.setItem("sealHistory",JSON.stringify(e))}},async mounted(){this.worker=await M.createWorker("eng")},beforeDestroy(){this.worker&&this.worker.terminate()},watch:{quantity:{handler(n){this.distributionType==="quantity"&&n>0&&this.generateDistributionCodes()}},distributionType(n){n==="single"&&this.scannedSeal?this.distributionCodes=[this.scannedSeal.code]:n==="quantity"&&(this.distributionCodes=[])},scannedSeal(n){n&&this.distributionType==="single"&&(this.distributionCodes=[n.code])}}},N={class:"distribute-seal"},U={key:0,class:"scanner-section"},E={class:"manual-input"},H={class:"input-with-button"},B=["disabled"],J={class:"upload-section"},L={class:"upload-button"},O={class:"scan-hint"},P={key:1,class:"form-section"},R={class:"seal-info"},j={class:"info-grid"},z={class:"info-item"},G={class:"info-item"},Z={class:"info-item"},K={class:"form-group"},Q={class:"form-group"},W={class:"distribution-type"},X={class:"radio-group"},Y={key:0,class:"quantity-input"},$={class:"form-group"},ee={class:"button-group"},te=["disabled"],se={key:2,class:"generated-codes-preview"},ie={class:"preview-header"},ne={class:"preview-actions"},oe={class:"count-badge"},ae={key:0,class:"add-code-form"},re={class:"input-group"},le={class:"input-actions"},de=["disabled"],ue={class:"code-list"},ce=["onClick"];function pe(n,e,a,l,s,o){const d=I("qrcode-stream");return p(),c("div",N,[e[34]||(e[34]=t("h2",null,"จ่าย Seal",-1)),s.scannedSeal?f("",!0):(p(),c("div",U,[t("div",E,[t("div",H,[h(t("input",{type:"text",placeholder:"กรอกรหัส Seal","onUpdate:modelValue":e[0]||(e[0]=i=>s.manualCode=i),class:"modern-input"},null,512),[[y,s.manualCode]]),t("button",{onClick:e[1]||(e[1]=(...i)=>o.handleManualInput&&o.handleManualInput(...i)),class:"confirm-btn-small",disabled:!s.manualCode,title:"ยืนยันรหัส"},e[15]||(e[15]=[t("i",{class:"fas fa-check"},null,-1)]),8,B)]),t("div",J,[t("label",L,[e[16]||(e[16]=t("i",{class:"fas fa-image"},null,-1)),e[17]||(e[17]=b(" อัพโหลดรูปภาพ ")),t("input",{type:"file",accept:"image/*",onChange:e[2]||(e[2]=(...i)=>o.onFileSelected&&o.onFileSelected(...i)),style:{display:"none"},capture:"environment"},null,32)])])]),k(d,{onDecode:o.onDecode,onInit:o.onInit,track:!0,camera:{facingMode:{exact:"environment"},width:{min:1280,ideal:1920,max:2560},height:{min:720,ideal:1080,max:1440}}},{default:q(()=>e[18]||(e[18]=[t("div",{class:"scan-target-frame"},[t("div",{class:"corner top-left"}),t("div",{class:"corner top-right"}),t("div",{class:"corner bottom-left"}),t("div",{class:"corner bottom-right"}),t("div",{class:"scanning-line"})],-1)])),_:1},8,["onDecode","onInit"]),t("p",O,m(s.scannerMessage),1)])),s.scannedSeal?(p(),c("div",P,[t("div",R,[e[22]||(e[22]=t("h3",null,"ข้อมูล Seal ที่สแกน",-1)),t("div",j,[t("div",z,[e[19]||(e[19]=t("label",null,"รหัส Seal:",-1)),t("span",null,m(s.scannedSeal.code),1)]),t("div",G,[e[20]||(e[20]=t("label",null,"ประเภท:",-1)),t("span",null,m(s.scannedSeal.type),1)]),t("div",Z,[e[21]||(e[21]=t("label",null,"สถานะ:",-1)),t("span",{class:T(["status",s.scannedSeal.status])},m(s.scannedSeal.status),3)])])]),t("form",{onSubmit:e[9]||(e[9]=F((...i)=>o.distributeSeal&&o.distributeSeal(...i),["prevent"])),class:"distribution-form"},[t("div",K,[e[23]||(e[23]=t("label",null,"รหัสช่าง:",-1)),h(t("input",{"onUpdate:modelValue":e[3]||(e[3]=i=>s.technicianCode=i),type:"text",class:"modern-input",placeholder:"กรอกรหัสช่าง",required:""},null,512),[[y,s.technicianCode]])]),t("div",Q,[e[26]||(e[26]=t("label",null,"จำนวน Seal:",-1)),t("div",W,[t("div",X,[t("label",null,[h(t("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=i=>s.distributionType=i),value:"single"},null,512),[[S,s.distributionType]]),e[24]||(e[24]=b(" จ่ายเฉพาะรหัสที่สแกน "))]),t("label",null,[h(t("input",{type:"radio","onUpdate:modelValue":e[5]||(e[5]=i=>s.distributionType=i),value:"quantity"},null,512),[[S,s.distributionType]]),e[25]||(e[25]=b(" ระบุจำนวน "))])]),s.distributionType==="quantity"?(p(),c("div",Y,[h(t("input",{"onUpdate:modelValue":e[6]||(e[6]=i=>s.quantity=i),type:"number",min:"1",placeholder:"ระบุจำนวน Seal ที่ต้องการจ่าย",class:"modern-input"},null,512),[[y,s.quantity]])])):f("",!0)])]),t("div",$,[e[27]||(e[27]=t("label",null,"หมายเหตุ:",-1)),h(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=i=>s.note=i),class:"modern-input",placeholder:"กรอกหมายเหตุ (ถ้ามี)",rows:"3"},null,512),[[y,s.note]])]),t("div",ee,[t("button",{type:"button",onClick:e[8]||(e[8]=(...i)=>o.resetForm&&o.resetForm(...i)),class:"btn-cancel"}," ยกเลิก "),t("button",{type:"submit",class:"btn-confirm",disabled:!o.isFormValid}," ยืนยันการจ่าย ("+m(s.distributionType==="quantity"?s.quantity||"0":"1")+" รายการ) ",9,te)])],32)])):f("",!0),s.distributionType==="quantity"&&s.quantity>0?(p(),c("div",se,[t("div",ie,[e[29]||(e[29]=t("h3",null,[t("i",{class:"fas fa-list-ol"}),b(" รหัส Seal ที่จะถูกจ่าย ")],-1)),t("div",ne,[t("button",{type:"button",class:"add-code-btn",onClick:e[10]||(e[10]=i=>s.showAddCodeInput=!0),title:"เพิ่มรหัสเพิ่มเติม"},e[28]||(e[28]=[t("i",{class:"fas fa-plus"},null,-1),b(" เพิ่มรหัส ")])),t("span",oe,m(s.distributionCodes.length)+" รายการ",1)])]),s.showAddCodeInput?(p(),c("div",ae,[t("div",re,[h(t("input",{"onUpdate:modelValue":e[11]||(e[11]=i=>s.additionalCode=i),type:"text",placeholder:"กรอกรหัส Seal ที่ต้องการเพิ่ม",class:"modern-input",onKeyup:e[12]||(e[12]=x((...i)=>o.addAdditionalCode&&o.addAdditionalCode(...i),["enter"]))},null,544),[[y,s.additionalCode]]),t("div",le,[t("button",{type:"button",class:"btn-add",onClick:e[13]||(e[13]=(...i)=>o.addAdditionalCode&&o.addAdditionalCode(...i)),disabled:!o.isValidCode(s.additionalCode)},e[30]||(e[30]=[t("i",{class:"fas fa-plus"},null,-1)]),8,de),t("button",{type:"button",class:"btn-cancel",onClick:e[14]||(e[14]=i=>s.showAddCodeInput=!1)},e[31]||(e[31]=[t("i",{class:"fas fa-times"},null,-1)]))])])])):f("",!0),t("div",ue,[(p(!0),c(V,null,A(s.distributionCodes,i=>(p(),c("div",{key:i,class:"code-item"},[e[33]||(e[33]=t("i",{class:"fas fa-check-circle"},null,-1)),b(" "+m(i)+" ",1),t("button",{class:"remove-code-btn",onClick:u=>o.removeCode(i),title:"ลบรหัสนี้"},e[32]||(e[32]=[t("i",{class:"fas fa-times"},null,-1)]),8,ce)]))),128))])])):f("",!0)])}const me=v(_,[["render",pe],["__scopeId","data-v-ea179fe5"]]);export{me as default};
